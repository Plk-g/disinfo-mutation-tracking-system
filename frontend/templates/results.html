{% extends "base.html" %}
{% block title %}Analysis Results â€“ {{ query[:50] }}{% endblock %}

{% block content %}
<div class="results-container">
  <!-- Header Section -->
  <div class="results-header">
    <div class="container">
      <a href="{{ url_for('index') }}" class="btn-back">
        <i class="bi bi-arrow-left"></i> Back to Analyzer
      </a>
      <h2 class="results-title">Analysis Results</h2>
    </div>
  </div>

  <div class="container">
    <!-- Query Display -->
    <div class="query-display-card">
      <div class="query-content">
        <i class="bi bi-quote"></i>
        <p class="query-text">{{ query }}</p>
      </div>
    </div>

    <!-- No Results Message -->
    {% if analysis.no_results %}
    <div class="no-results-card">
      <div class="no-results-content">
        <i class="bi bi-search"></i>
        <h3>No Results Found</h3>
        <p>{{ analysis.reasoning }}</p>
        <div class="no-results-suggestions">
          <h5>What this means:</h5>
          <ul>
            <li>This claim may be new and not yet in our database</li>
            <li>The claim might be authentic and not associated with known disinformation</li>
            <li>Our system may not have processed similar narratives yet</li>
          </ul>
        </div>
        <div class="no-results-actions">
          <a href="{{ url_for('index') }}" class="btn btn-primary">
            <i class="bi bi-arrow-left"></i> Try Another Search
          </a>
        </div>
      </div>
    </div>
    {% else %}
    <!-- Main Analysis Cards -->
    <div class="row mb-4">
      <!-- Fake Percentage Card -->
      <div class="col-lg-6 mb-4">
        <div class="analysis-card fake-card">
          <div class="card-header-analysis">
            <i class="bi bi-exclamation-triangle-fill"></i>
            <h3>Likely Disinformation</h3>
          </div>
          <div class="percentage-display">
            <div class="percentage-circle" data-percent="{{ analysis.fake_percentage }}">
              <svg class="progress-ring" width="200" height="200">
                <circle class="progress-ring-circle" cx="100" cy="100" r="90" />
              </svg>
              <div class="percentage-text">
                <span class="percentage-number">{{ analysis.fake_percentage }}%</span>
                <span class="percentage-label">Fake</span>
              </div>
            </div>
          </div>
          <div class="confidence-badge confidence-{{ analysis.confidence }}">
            <i class="bi bi-info-circle"></i>
            Confidence: {{ analysis.confidence|title }}
          </div>
        </div>
      </div>

      <!-- Real Percentage Card -->
      <div class="col-lg-6 mb-4">
        <div class="analysis-card real-card">
          <div class="card-header-analysis">
            <i class="bi bi-check-circle-fill"></i>
            <h3>Likely Authentic</h3>
          </div>
          <div class="percentage-display">
            <div class="percentage-circle" data-percent="{{ analysis.real_percentage }}">
              <svg class="progress-ring" width="200" height="200">
                <circle class="progress-ring-circle real-circle" cx="100" cy="100" r="90" />
              </svg>
              <div class="percentage-text">
                <span class="percentage-number">{{ analysis.real_percentage }}%</span>
                <span class="percentage-label">Real</span>
              </div>
            </div>
          </div>
          <div class="confidence-badge confidence-{{ analysis.confidence }}">
            <i class="bi bi-shield-check"></i>
            Based on {{ analysis.total_matches }} similar narratives
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Reasoning Section (only show if we have results) -->
    {% if not analysis.no_results %}
    <div class="reasoning-card">
      <h4><i class="bi bi-lightbulb"></i> Analysis Reasoning</h4>
      <p>{{ analysis.reasoning }}</p>
      {% if analysis.avg_similarity %}
      <div class="stats-row">
        <span class="stat-item">
          <strong>Avg. Similarity:</strong> {{ analysis.avg_similarity }}
        </span>
        <span class="stat-item">
          <strong>Match Rate:</strong> {{ analysis.match_rate }}%
        </span>
        <span class="stat-item">
          <strong>Total Matches:</strong> {{ analysis.total_matches }}
        </span>
      </div>
      {% endif %}
    </div>
    {% endif %}

    <!-- Citations Section -->
    {% if analysis.citations %}
    <div class="citations-section">
      <h4><i class="bi bi-link-45deg"></i> Source Citations</h4>
      <p class="section-subtitle">Similar narratives found in our database:</p>
      <div class="citations-list">
        {% for citation in analysis.citations %}
        <div class="citation-item">
          <div class="citation-header">
            <span class="citation-source badge bg-secondary">
              <i class="bi bi-{{ 'twitter' if citation.source == 'twitter' else 'reddit' if citation.source == 'reddit' else 'newspaper' }}"></i>
              {{ citation.source|title }}
            </span>
            <span class="citation-similarity badge bg-{{ 'danger' if citation.similarity > 0.8 else 'warning' }}">
              {{ (citation.similarity * 100)|round(1) }}% similar
            </span>
          </div>
          <p class="citation-text">{{ citation.text }}</p>
          <div class="citation-footer">
            <small class="text-muted">
              <i class="bi bi-clock"></i> {{ citation.timestamp[:10] if citation.timestamp else 'Unknown date' }}
              {% if citation.claim_id %}
              | <i class="bi bi-tag"></i> Claim: {{ citation.claim_id }}
              {% endif %}
            </small>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- Mutation Tracking Section (only show if we have results) -->
    {% if not analysis.no_results %}
    <div class="mutations-section">
      <div class="mutations-header">
        <h4><i class="bi bi-diagram-3"></i> Narrative Mutation Tracking</h4>
        <a href="{{ url_for('mutations_page') }}" class="btn btn-outline-primary btn-sm">
          <i class="bi bi-arrow-right"></i> View All Mutations
        </a>
      </div>
      
      {% if analysis.mutation_info and analysis.mutation_info.has_mutations %}
      <div class="mutation-alert">
        <i class="bi bi-exclamation-triangle"></i>
        <div>
          <strong>Mutations Detected!</strong>
          <p>This narrative has {{ analysis.mutation_info.mutation_count }} detected mutations with a top score of {{ analysis.mutation_info.top_mutation_score|round(2) }}.</p>
        </div>
      </div>
      {% endif %}

      {% if mutations %}
      <div class="mutations-preview">
        <p class="section-subtitle">Top narrative mutations in our system:</p>
        <div class="row">
          {% for mutation in mutations[:3] %}
          <div class="col-md-4 mb-3">
            <div class="mutation-card">
              <div class="mutation-header">
                <code>{{ mutation.cluster_id }}</code>
                <span class="mutation-type badge bg-info">{{ mutation.mutation_type|replace('_', ' ')|title }}</span>
              </div>
              <div class="mutation-score">
                <strong>Score:</strong> {{ mutation.mutation_score|round(3) }}
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      {% else %}
      <div class="no-mutations">
        <i class="bi bi-info-circle"></i>
        <p>No significant mutations detected for this narrative cluster.</p>
      </div>
      {% endif %}
    </div>
    {% endif %}

    <!-- Action Buttons -->
    {% if not analysis.no_results %}
    <div class="action-buttons">
      <a href="{{ url_for('index') }}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Analyze Another Article
      </a>
      <a href="{{ url_for('mutations_page') }}" class="btn btn-primary">
        <i class="bi bi-diagram-3"></i> View Mutation Dashboard
      </a>
    </div>
    {% endif %}
  </div>
</div>

<script>
// Animate percentage circles (only if they exist)
document.addEventListener('DOMContentLoaded', function() {
  const circles = document.querySelectorAll('.percentage-circle');
  circles.forEach(circle => {
    const percent = parseFloat(circle.getAttribute('data-percent'));
    if (isNaN(percent)) return; // Skip if no valid percentage
    
    const circleElement = circle.querySelector('.progress-ring-circle');
    if (!circleElement) return;
    
    const circumference = 2 * Math.PI * 90;
    const offset = circumference - (percent / 100) * circumference;
    
    circleElement.style.strokeDasharray = `${circumference} ${circumference}`;
    circleElement.style.strokeDashoffset = circumference;
    
    setTimeout(() => {
      circleElement.style.transition = 'stroke-dashoffset 1.5s ease-in-out';
      circleElement.style.strokeDashoffset = offset;
    }, 100);
  });
});
</script>
{% endblock %}
